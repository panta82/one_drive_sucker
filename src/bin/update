#!/usr/bin/env node

const settings = require('../settings');

const libPath = require('path');

const fsExtra = require('fs-extra');
const { logger } = require('mayan-logger');

const { createOneDriveClient } = require('../one_drive_client');

main().catch(err => {
  console.error(err.stack || err);
  process.exit(1);
});

// *********************************************************************************************************************

async function main() {
  const log = logger.log;

  const oneDriveClient = createOneDriveClient(logger.for('OneDrive client'));

  if (libPath.resolve(settings.targetDir) === libPath.resolve(settings.scratchDir)) {
    throw new Error(`Your scratch and target dir shouldn't be the same`);
  }

  log.info(`Preparing target location at ${settings.targetDir}...`);
  await fsExtra.ensureDir(libPath.resolve(settings.targetDir));

  log.info(`Preparing scratch dir at ${settings.scratchDir}...`);
  await fsExtra.emptyDir(libPath.resolve(settings.scratchDir));

  log.info(`Downloading the drive...`);

  const downloadResult = await oneDriveClient.downloadFolder(
    settings.sourceUrl,
    libPath.resolve(settings.scratchDir, 'sucked.zip')
  );

  log.info(`TODO...`, downloadResult);
}
